<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>정보글 관리</title>
</head>
<body>
    <button id="btnIns" onclick="openInsertModal()">정보 입력</button>

    <div class="modal-container" id="insertModalContainer">
        <div class="modal-content">
            <h3>새 정보 입력</h3>
            분류 <input type="text" id="inputCategory" list="categoryPresets" placeholder="분류"><br>
            제목 <input type="text" id="inputTitle" placeholder="제목"><br>
            링크 <input type="text" id="inputLink" placeholder="주소">
            <div style="margin-top:20px;">
                <button id="btnRes" onclick="addRes()">등록</button>
                <button onclick="closeModal(dom.insertModalContainer)">닫기</button>
            </div>
        </div>
    </div>

    <div class="modal-container" id="editModalContainer">
        <div class="modal-content">
            <h3>정보 수정</h3>
            <input type="hidden" id="editOldCategory">
            <input type="hidden" id="editOldTitle">
            
            분류 <input type="text" id="editCategory" list="categoryPresets"><br>
            제목 <input type="text" id="editTitle"><br>
            링크 <input type="text" id="editLink">
            <div style="margin-top:20px;">
                <button id="btnUpdate" onclick="submitUpdate()">수정 완료</button>
                <button onclick="closeModal(dom.editModalContainer)">취소</button>
            </div>
        </div>
    </div>

    <div class="container">
        <h1>정보 목록</h1>
        <div class="search-box">
            <select id="category"></select>
            <input type="text" id="searchText" placeholder="검색어를 입력하세요.">
            <button id="btnSearch" onclick="searchData()">검색</button>
        </div>
        <div class="main-table">
            <table>
                <thead>
                    <tr>
                        <th style="width: 10%;">순번</th>
                        <th style="width: 20%;">분류</th>
                        <th style="width: 50%;">제목</th>
                        <th style="width: 20%;">등록일</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
        <div id="pagination" class="pagination"></div>
    </div>

    <!-- 카테고리 프리셋 -->
    <datalist id="categoryPresets"></datalist>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycby1_2VZxHfxHrgltVD5gZ0yX2S2SAQuUpw4ELbgtkvF_GlasGdamQHPmR7QAeGMfv_R/exec";
        let categoryList = [];
        let currentPage = 1;
        const rowsPerPage = 10;
        let allRows = [];
        let matchedRows = [];

        // 도우미
        const gid = (id) => document.getElementById(id);
        const tag = (n) => document.createElement(n);

        // 주요 돔 관리
        const dom = {
            tableBody: gid("tableBody"),
            category: gid("category"),
            searchText: gid("searchText"),
            pagination: gid("pagination"),

            btnRes: gid("btnRes"),
            insertModalContainer: gid("insertModalContainer"),

            btnUpdate: gid("btnUpdate"),
            editModalContainer: gid("editModalContainer"),
            editOldCategory: gid("editOldCategory"),
            editOldTitle: gid("editOldTitle"),
            editCategory: gid("editCategory"),
            editTitle: gid("editTitle"),
            editLink: gid("editLink")
        }

        // 데이터 불러오기
        function loadData() {
            dom.tableBody.innerHTML = "<tr><td colspan='4'>로딩 중...</td></tr>";
            dom.category.innerHTML = '<option value="모두">모두</option>';
            categoryList = ["모두"];

            fetch(API_URL)
            .then(res => res.json())
            .then(data => {
                dom.tableBody.innerHTML = "";
                data.forEach(item => {
                    updateCategoryList(item.분류);
                    addRow(item.분류, item.제목, item.등록일, item.링크);
                });
                allRows = Array.from(dom.tableBody.querySelectorAll("tr"));
                searchData();
            });
        }

        // 카테고리 목록 업데이트
        function updateCategoryList(category) {
            if (!categoryList.includes(category)) {
                categoryList.push(category);

                let opt = tag("option");
                opt.value = opt.text = category;
                dom.category.add(opt);

                let dataOpt = tag("option");
                dataOpt.value = category;
                gid("categoryPresets").appendChild(dataOpt);
            }
        }

        // 행 추가하기
        function addRow(category, title, date, link) {
            let tr = tag("tr");
            tr.dataset.link = link;
            tr.dataset.title = title;
            tr.dataset.category = category;

            tr.innerHTML = `
                <td class="td-index"></td>
                <td class="td-category" title="더블클릭하여 수정">${category}</td>
                <td class="td-title" title="클릭하여 이동">${title}</td>
                <td>${new Date(date).toLocaleDateString('ko-KR')}</td>
            `;

            tr.querySelector(".td-category").ondblclick = () => openEditModal(category, title, link);
            tr.querySelector(".td-title").onclick = () => { if(link) window.open(link, "_blank"); };
            dom.tableBody.appendChild(tr);
        }

        // 필터링 (검색 버튼, 카테고리 변경 시 호출)
        function searchData() {
            let sText = dom.searchText.value.toLowerCase();
            let sCat = dom.category.value;

            matchedRows = allRows.filter(r => {
                let t = r.dataset.title.toLowerCase();
                let c = r.dataset.category;
                return (sText === "" || t.includes(sText)) && (sCat === "모두" || c === sCat);
            });

            currentPage = 1;
            renderTable();
        }

        // 현재 페이지의 행만 보여주기 (페이지 번호 클릭 시 호출)
        function renderTable() {
            allRows.forEach(r => r.style.display = "none");

            let start = (currentPage - 1) * rowsPerPage;
            let end = start + rowsPerPage;
            
            let pageRows = matchedRows.slice(start, end);
            
            pageRows.forEach((r, index) => {
                r.style.display = "";
                r.querySelector(".td-index").innerText = start + index + 1;
            });

            renderPagination();
        }

        // 페이지네이션 (테이블 그릴 시 호출)
        function renderPagination() {
            let nav = dom.pagination;
            nav.innerHTML = "";
            let totalPages = Math.ceil(matchedRows.length / rowsPerPage);

            if (totalPages === 0) return;

            for (let i = 1; i <= totalPages; i++) {
                let b = tag("button");
                b.innerText = i;
                if (i === currentPage) b.className = "active";
                b.onclick = () => { 
                    currentPage = i; 
                    renderTable();
                };
                nav.appendChild(b);
            }
        }

        // 모달 열고 닫기
        function openModal(modalId) {
            modalId.style.display = "block";
        }
        function closeModal(modalId) {
            modalId.style.display = "none";
        }

        // 정보 입력 모달 제어 
        function openInsertModal() {
            openModal(dom.insertModalContainer);
        }

        // 정보 수정 모달 제어
        function openEditModal(c, t, l) {
           dom.editOldCategory.value = c;
            dom.editOldTitle.value = t;
            dom.editCategory.value = c;
            dom.editTitle.value = t;
            dom.editLink.value = l;
            openModal(dom.editModalContainer);
        }

        // 새 정보 등록 
        function addRes() {
            let category = gid("inputCategory").value.trim();
            let tit = gid("inputTitle").value.trim();
            let lnk = gid("inputLink").value.trim();
            if(!category || !tit || !lnk) return alert("모든 내용을 입력하세요.");
            dom.btnRes.disabled = true;
            fetch(API_URL, {
                method: "POST",
                body: JSON.stringify({ category: category, title: tit, link: lnk, date: new Date().toISOString().slice(0, 10) })
            }).then(() => location.reload());
        }

        // 데이터 업데이트 
        function submitUpdate() {
            let payload = {
                action: "updateCategory",
                oldCategory: dom.editOldCategory.value,
                title: dom.editOldTitle.value,
                newCategory: dom.editCategory.value.trim(),
                newTitle: dom.editTitle.value.trim(),
                newLink: dom.editLink.value.trim()
            };
            dom.btnUpdate.disabled = true;
            fetch(API_URL, { method: "POST", body: JSON.stringify(payload) })
            .then(() => location.reload())
            .catch(() => { alert("오류 발생"); dom.btnUpdate.disabled = false; });
        }

        window.onload = loadData;
        window.onclick = (event) => {
            if (event.target.classList.contains('modal-container')) {
                closeModal(event.target);
            }
        }
        dom.category.onchange = searchData;
        dom.searchText.onkeypress = (e) => { if(e.key === "Enter") searchData(); };

    </script>
</body>
</html>